/**
 * ArbitroBot Mind Map Core Module
 * Handles: Initialization, Data Setup, Animation Loop, Transforms
 */

class MindMapCore {
    constructor() {
        this.svg = null;
        this.contentGroup = null;
        this.nodes = [];
        this.links = [];

        // Transform state
        this.currentScale = 1;
        this.targetScale = 1;
        this.currentX = 0;
        this.currentY = 0;
        this.targetX = 0;
        this.targetY = 0;

        // Animation state
        this.animationFrame = null;
        this.isAnimating = false;

        // Drag state
        this.isDragging = false;
        this.isPanning = false;
        this.draggedNode = null;
        this.dragStartX = 0;
        this.dragStartY = 0;

        // Viewport
        this.viewBoxWidth = 1400;
        this.viewBoxHeight = 900;

        // Throttle state
        this.lastWheelTime = 0;
        this.wheelThrottle = 16; // ~60fps

        // Touch/pinch state for mobile
        this.touches = [];
        this.lastPinchDistance = 0;
        this.isPinching = false;

        this.initialized = false;
    }

    /**
     * Smooth easing functions
     */
    easeOutCubic(t) {
        return 1 - Math.pow(1 - t, 3);
    }

    easeInOutQuad(t) {
        return t < 0.5 ? 2 * t * t : 1 - Math.pow(-2 * t + 2, 2) / 2;
    }

    easeOutQuart(t) {
        return 1 - Math.pow(1 - t, 4);
    }

    /**
     * Interpolate between current and target values
     */
    lerp(start, end, alpha) {
        return start + (end - start) * alpha;
    }

    /**
     * Initialize the mind map
     */
    init() {
        if (this.initialized) return;

        this.svg = document.getElementById('mindmapSvg');
        this.contentGroup = document.getElementById('mindmapContent');

        if (!this.svg || !this.contentGroup) {
            console.error('Mind map SVG elements not found');
            return;
        }

        this.setupData();

        // Delegate rendering to render module
        if (window.MindMapRender) {
            window.MindMapRender.render(this);
            window.MindMapRender.setupEventListeners(this);
        }

        this.centerView();
        this.startAnimationLoop();

        this.initialized = true;
    }

    /**
     * Main animation loop for smooth 60fps animations
     */
    startAnimationLoop() {
        const animate = () => {
            // Smooth interpolation towards target
            const alpha = 0.2;

            this.currentScale = this.lerp(this.currentScale, this.targetScale, alpha);
            this.currentX = this.lerp(this.currentX, this.targetX, alpha);
            this.currentY = this.lerp(this.currentY, this.targetY, alpha);

            // Apply SVG transform
            this.applyTransform();

            // Continue animation loop
            this.animationFrame = requestAnimationFrame(animate);
        };

        animate();
    }

    /**
     * Apply transform to content group using SVG transform
     */
    applyTransform() {
        const transform = `translate(${this.currentX}, ${this.currentY}) scale(${this.currentScale})`;
        this.contentGroup.setAttribute('transform', transform);
    }

    /**
     * Setup mind map data structure - ArbitroBot specific
     */
    setupData() {
        // Define all nodes in the mind map
        this.nodes = [
            // Core
            { id: 'core', label: 'ArbitroBot', type: 'core', x: 700, y: 450, icon: 'ü§ñ', description: '–ê—Ä–±–∏—Ç—Ä–∞–∂–Ω–∞—è –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞' },

            // Main sections
            { id: 'monitoring', label: '–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥', type: 'page', x: 400, y: 250, icon: 'üìä', description: 'Real-time –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥' },
            { id: 'bot-control', label: '–ü–∞–Ω–µ–ª—å –±–æ—Ç–∞', type: 'page', x: 1000, y: 250, icon: 'üéõÔ∏è', description: '–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–æ—Ç–æ–º' },
            { id: 'user-dashboard', label: '–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç', type: 'page', x: 700, y: 150, icon: 'üë§', description: 'Dashboard –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è' },
            { id: 'about', label: '–û –ø—Ä–æ–µ–∫—Ç–µ', type: 'page', x: 300, y: 450, icon: '‚ÑπÔ∏è', description: '–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è' },
            { id: 'faq', label: 'FAQ', type: 'page', x: 1100, y: 450, icon: '‚ùì', description: '–ß–∞—Å—Ç—ã–µ –≤–æ–ø—Ä–æ—Å—ã' },

            // Monitoring features
            { id: 'real-time', label: 'Real-time –¥–∞–Ω–Ω—ã–µ', type: 'feature', x: 200, y: 150, icon: '‚ö°', description: 'WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ' },
            { id: 'transactions', label: '–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏', type: 'feature', x: 250, y: 350, icon: 'üìù', description: '–ò—Å—Ç–æ—Ä–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π' },
            { id: 'user-stats', label: '–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞', type: 'feature', x: 400, y: 100, icon: 'üìà', description: '–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è' },

            // Bot control features
            { id: 'dashboard-tab', label: 'Dashboard', type: 'feature', x: 1150, y: 150, icon: 'üìä', description: '–û–±–∑–æ—Ä —Å–æ—Å—Ç–æ—è–Ω–∏—è' },
            { id: 'wallet-tab', label: '–ö–æ—à–µ–ª—ë–∫', type: 'feature', x: 1200, y: 250, icon: 'üí∞', description: '–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—Ä–µ–¥—Å—Ç–≤–∞–º–∏' },
            { id: 'scanner-tab', label: '–°–∫–∞–Ω–µ—Ä', type: 'feature', x: 1250, y: 350, icon: 'üîç', description: '–ü–æ–∏—Å–∫ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π' },
            { id: 'contract-tab', label: '–ö–æ–Ω—Ç—Ä–∞–∫—Ç—ã', type: 'feature', x: 900, y: 100, icon: 'üìÑ', description: 'Smart contracts' },
            { id: 'statistics-tab', label: '–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞', type: 'feature', x: 850, y: 200, icon: 'üìä', description: '–î–µ—Ç–∞–ª—å–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞' },
            { id: 'decisions-tab', label: '–†–µ—à–µ–Ω–∏—è', type: 'feature', x: 950, y: 350, icon: 'üéØ', description: '–¢–æ—Ä–≥–æ–≤—ã–µ —Ä–µ—à–µ–Ω–∏—è' },
            { id: 'lists-tab', label: '–°–ø–∏—Å–∫–∏ —Ç–æ–∫–µ–Ω–æ–≤', type: 'feature', x: 1050, y: 400, icon: 'üìã', description: 'White/Black/Gray lists' },
            { id: 'arbitrage-tab', label: '–ê—Ä–±–∏—Ç—Ä–∞–∂', type: 'feature', x: 1150, y: 500, icon: 'üíπ', description: '–ê—Ä–±–∏—Ç—Ä–∞–∂–Ω—ã–µ –ø–∞—Ä—ã' },
            { id: 'node-tab', label: '–ù–æ–¥—ã', type: 'feature', x: 1000, y: 550, icon: 'üåê', description: 'RPC –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è' },
            { id: 'terminal-tab', label: '–¢–µ—Ä–º–∏–Ω–∞–ª', type: 'feature', x: 850, y: 500, icon: 'üíª', description: '–ö–æ–Ω—Å–æ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è' },

            // Technology & Data sources
            { id: 'bsc', label: 'BNB Chain', type: 'data', x: 500, y: 700, icon: '‚õìÔ∏è', description: 'Blockchain —Å–µ—Ç—å' },
            { id: 'websocket', label: 'WebSocket', type: 'data', x: 700, y: 750, icon: 'üîå', description: 'Real-time —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ' },
            { id: 'api', label: 'REST API', type: 'data', x: 900, y: 700, icon: 'üîó', description: 'HTTP API' },
            { id: 'dex', label: 'DEX –±–∏—Ä–∂–∏', type: 'data', x: 300, y: 700, icon: 'üîÑ', description: 'PancakeSwap, Biswap' },

            // Conditions and Requirements
            { id: 'condition-access', label: '–û—Ç–∫—Ä—ã—Ç—ã–π –¥–æ—Å—Ç—É–ø', type: 'condition', x: 150, y: 550, icon: 'üîì', description: '–ë–µ–∑ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏' },
            { id: 'condition-mobile', label: '–ú–æ–±–∏–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è', type: 'condition', x: 1250, y: 600, icon: 'üì±', description: '–ê–¥–∞–ø—Ç–∏–≤–Ω—ã–π –¥–∏–∑–∞–π–Ω' },
            { id: 'condition-flash', label: 'Flash Loans', type: 'condition', x: 500, y: 550, icon: '‚ö°', description: '–ë–µ–∑—Ä–∏—Å–∫–æ–≤—ã–µ –∑–∞–π–º—ã' },
            { id: 'condition-security', label: '–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å', type: 'condition', x: 900, y: 600, icon: 'üîê', description: '–ó–∞—â–∏—Ç–∞ —Å—Ä–µ–¥—Å—Ç–≤' },

            // User Journey
            { id: 'user-new', label: '–ù–æ–≤—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏', type: 'feature', x: 200, y: 600, icon: 'üë∂', description: '–ù–∞—á–∞–ª–æ —Ä–∞–±–æ—Ç—ã' },
            { id: 'user-advanced', label: '–û–ø—ã—Ç–Ω—ã–µ —Ç—Ä–µ–π–¥–µ—Ä—ã', type: 'feature', x: 1100, y: 650, icon: 'üéì', description: '–†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏' },
        ];

        // Define connections between nodes
        this.links = [
            // Core connections
            { source: 'core', target: 'monitoring' },
            { source: 'core', target: 'bot-control' },
            { source: 'core', target: 'user-dashboard' },
            { source: 'core', target: 'about' },
            { source: 'core', target: 'faq' },

            // Monitoring connections
            { source: 'monitoring', target: 'real-time' },
            { source: 'monitoring', target: 'transactions' },
            { source: 'monitoring', target: 'user-stats' },

            // Bot control connections
            { source: 'bot-control', target: 'dashboard-tab' },
            { source: 'bot-control', target: 'wallet-tab' },
            { source: 'bot-control', target: 'scanner-tab' },
            { source: 'bot-control', target: 'contract-tab' },
            { source: 'bot-control', target: 'statistics-tab' },
            { source: 'bot-control', target: 'decisions-tab' },
            { source: 'bot-control', target: 'lists-tab' },
            { source: 'bot-control', target: 'arbitrage-tab' },
            { source: 'bot-control', target: 'node-tab' },
            { source: 'bot-control', target: 'terminal-tab' },

            // Data source connections
            { source: 'real-time', target: 'websocket' },
            { source: 'scanner-tab', target: 'dex' },
            { source: 'arbitrage-tab', target: 'dex' },
            { source: 'wallet-tab', target: 'bsc' },
            { source: 'contract-tab', target: 'bsc' },
            { source: 'transactions', target: 'api' },
            { source: 'node-tab', target: 'bsc' },

            // Condition connections
            { source: 'monitoring', target: 'condition-access' },
            { source: 'core', target: 'condition-mobile' },
            { source: 'arbitrage-tab', target: 'condition-flash' },
            { source: 'wallet-tab', target: 'condition-security' },

            // User journey connections
            { source: 'user-new', target: 'monitoring' },
            { source: 'user-new', target: 'about' },
            { source: 'user-new', target: 'faq' },
            { source: 'user-advanced', target: 'bot-control' },
            { source: 'user-advanced', target: 'user-dashboard' },

            // Cross connections
            { source: 'user-dashboard', target: 'user-stats' },
        ];
    }

    /**
     * Smooth zoom with target interpolation
     */
    smoothZoom(factor) {
        this.targetScale = Math.max(0.3, Math.min(3, this.targetScale * factor));
    }

    /**
     * Reset view
     */
    reset() {
        this.targetScale = 1;
        this.targetX = 0;
        this.targetY = 0;
    }

    /**
     * Center view on the core node
     */
    centerView() {
        const coreNode = this.nodes.find(n => n.id === 'core');
        if (!coreNode) return;

        const svgRect = this.svg.getBoundingClientRect();
        this.targetX = svgRect.width / 2 - coreNode.x;
        this.targetY = svgRect.height / 2 - coreNode.y;
        this.targetScale = 1;
    }

    /**
     * Cleanup
     */
    destroy() {
        if (this.animationFrame) {
            cancelAnimationFrame(this.animationFrame);
        }
        this.initialized = false;
    }
}

// Export to window for global access
if (typeof window !== 'undefined') {
    window.MindMapCore = MindMapCore;
}
