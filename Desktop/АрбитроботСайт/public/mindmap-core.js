/**
 * ArbitroBot Mind Map Core Module
 * Handles: Initialization, Data Setup, Animation Loop, Transforms
 */

class MindMapCore {
    constructor() {
        this.svg = null;
        this.contentGroup = null;
        this.nodes = [];
        this.links = [];

        // Transform state
        this.currentScale = 1;
        this.targetScale = 1;
        this.currentX = 0;
        this.currentY = 0;
        this.targetX = 0;
        this.targetY = 0;

        // Animation state
        this.animationFrame = null;
        this.isAnimating = false;

        // Drag state
        this.isDragging = false;
        this.isPanning = false;
        this.draggedNode = null;
        this.dragStartX = 0;
        this.dragStartY = 0;

        // Viewport
        this.viewBoxWidth = 1400;
        this.viewBoxHeight = 900;

        // Throttle state
        this.lastWheelTime = 0;
        this.wheelThrottle = 16; // ~60fps

        // Touch/pinch state for mobile
        this.touches = [];
        this.lastPinchDistance = 0;
        this.isPinching = false;

        this.initialized = false;
    }

    /**
     * Smooth easing functions
     */
    easeOutCubic(t) {
        return 1 - Math.pow(1 - t, 3);
    }

    easeInOutQuad(t) {
        return t < 0.5 ? 2 * t * t : 1 - Math.pow(-2 * t + 2, 2) / 2;
    }

    easeOutQuart(t) {
        return 1 - Math.pow(1 - t, 4);
    }

    /**
     * Interpolate between current and target values
     */
    lerp(start, end, alpha) {
        return start + (end - start) * alpha;
    }

    /**
     * Initialize the mind map
     */
    init() {
        if (this.initialized) return;

        this.svg = document.getElementById('mindmapSvg');
        this.contentGroup = document.getElementById('mindmapContent');

        if (!this.svg || !this.contentGroup) {
            console.error('Mind map SVG elements not found');
            return;
        }

        this.setupData();

        // Delegate rendering to render module
        if (window.MindMapRender) {
            window.MindMapRender.render(this);
            window.MindMapRender.setupEventListeners(this);
        }

        this.centerView();
        this.startAnimationLoop();

        this.initialized = true;
    }

    /**
     * Main animation loop for smooth 60fps animations
     */
    startAnimationLoop() {
        const animate = () => {
            // Smooth interpolation towards target
            const alpha = 0.2;

            this.currentScale = this.lerp(this.currentScale, this.targetScale, alpha);
            this.currentX = this.lerp(this.currentX, this.targetX, alpha);
            this.currentY = this.lerp(this.currentY, this.targetY, alpha);

            // Apply SVG transform
            this.applyTransform();

            // Continue animation loop
            this.animationFrame = requestAnimationFrame(animate);
        };

        animate();
    }

    /**
     * Apply transform to content group using SVG transform
     */
    applyTransform() {
        const transform = `translate(${this.currentX}, ${this.currentY}) scale(${this.currentScale})`;
        this.contentGroup.setAttribute('transform', transform);
    }

    /**
     * Setup mind map data structure - ArbitroBot Step-by-Step Journey
     */
    setupData() {
        // Define all nodes in the mind map
        // –ù–û–í–ê–Ø –°–¢–†–£–ö–¢–£–†–ê: —à–∞–≥–∏ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ —Å–ª–µ–≤–∞ –Ω–∞–ø—Ä–∞–≤–æ, —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è —Å–≤–µ—Ä—Ö—É/—Å–Ω–∏–∑—É, –Ω–µ–¥–µ–ª–∏ –∑–∏–≥–∑–∞–≥–æ–º
        this.nodes = [
            // ===== –®–ê–ì 1: –ü–û–î–ì–û–¢–û–í–ö–ê (x=150) =====
            {
                id: 'step1-plex',
                label: '–®–ê–ì 1: PLEX –•–æ–ª–¥–∏–Ω–≥',
                type: 'requirement',
                x: 150,
                y: 250,
                svgIcon: '/assets/icons-arbitrage/safe.svg',
                description: '5,000-25,000+ PLEX\n–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—É–º–º\n‚ö†Ô∏è –ü—Ä–æ–¥–∞–∂–∞ = –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –±–æ—Ç–∞'
            },
            {
                id: 'step1-rabbits',
                label: '–®–ê–ì 1: –ö—Ä–æ–ª–∏–∫–∏',
                type: 'requirement',
                x: 150,
                y: 650,
                svgIcon: '/assets/icons-arbitrage/rabbit.svg',
                description: '1-15+ –∂–∏–≤—ã—Ö –∫—Ä–æ–ª–∏–∫–æ–≤\n–¢–æ–∫–µ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Ñ–µ—Ä–º–∞\nüí∞ –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –¥–æ—Ö–æ–¥ –∑–∞ 120 –¥–Ω–µ–π'
            },

            // ===== –®–ê–ì 2: –ù–ê–°–¢–†–û–ô–ö–ê (x=350) =====
            {
                id: 'step2-deposit',
                label: '–®–ê–ì 2: –î–µ–ø–æ–∑–∏—Ç',
                type: 'requirement',
                x: 350,
                y: 250,
                svgIcon: '/assets/icons-arbitrage/coins.svg',
                description: '–û—Ç $100 –∏ –≤—ã—à–µ\n–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è $500-1,000\nüîÑ –ò–∑–º–µ–Ω–µ–Ω–∏–µ = —Å–±—Ä–æ—Å –ø—Ä–æ–≥—Ä–µ—Å—Å–∞'
            },
            {
                id: 'step2-commission',
                label: '–®–ê–ì 2: –ö–æ–º–∏—Å—Å–∏—è',
                type: 'requirement',
                x: 350,
                y: 650,
                svgIcon: '/assets/icons-arbitrage/clock-coin.svg',
                description: '10 PLEX –∑–∞ –∫–∞–∂–¥—ã–π $1\n–û–ø–ª–∞—Ç–∞ –ö–ê–ñ–î–´–ô –î–ï–ù–¨\nüìÖ –ë–µ–∑ –ø—Ä–æ–ø—É—Å–∫–æ–≤'
            },

            // ===== –®–ê–ì 3: –†–ê–ë–û–¢–ê –ë–û–¢–ê - –ù–ï–î–ï–õ–ò –ó–ò–ì–ó–ê–ì–û–ú (x=550-700) =====
            // –°–Ω–∏–∑—É –≤–≤–µ—Ä—Ö: 1-—è –≤–Ω–∏–∑—É, 2-—è –ø—Ä–∞–≤–µ–µ, 3-—è –ª–µ–≤–µ–µ, 4-—è –ø—Ä–∞–≤–µ–µ, 5+ –ª–µ–≤–µ–µ, –º–µ—Å—è—Ü 3 –ø—Ä–∞–≤–µ–µ
            {
                id: 'step3-week1',
                label: '–®–ê–ì 3: –ù–µ–¥–µ–ª—è 1',
                type: 'timeline',
                x: 550,
                y: 750,
                svgIcon: '/assets/icons-arbitrage/sprout.svg',
                description: '–ù–∞—á–∞–ª—å–Ω–∞—è –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç—å\n–ê–¥–∞–ø—Ç–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º—ã\n–ü–µ—Ä–≤—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã'
            },
            {
                id: 'step3-week2',
                label: '–ù–µ–¥–µ–ª—è 2',
                type: 'timeline',
                x: 700,
                y: 630,
                svgIcon: '/assets/icons-arbitrage/young-tree.svg',
                description: '–†–æ—Å—Ç –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç–∏\n–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∞–ª–≥–æ—Ä–∏—Ç–º–æ–≤\n–£–≤–µ–ª–∏—á–µ–Ω–∏–µ –ø—Ä–∏–±—ã–ª–∏'
            },
            {
                id: 'step3-week3',
                label: '–ù–µ–¥–µ–ª—è 3',
                type: 'timeline',
                x: 550,
                y: 510,
                svgIcon: '/assets/icons-arbitrage/tree.svg',
                description: '–°—Ç–∞–±–∏–ª—å–Ω–∞—è —Ä–∞–±–æ—Ç–∞\n–£—Å—Ç–æ–π—á–∏–≤—ã–π —Ä–æ—Å—Ç\n–†–µ–≥—É–ª—è—Ä–Ω–∞—è –ø—Ä–∏–±—ã–ª—å'
            },
            {
                id: 'step3-week4',
                label: '–ù–µ–¥–µ–ª—è 4',
                type: 'timeline',
                x: 700,
                y: 390,
                svgIcon: '/assets/icons-arbitrage/fruit-tree.svg',
                description: '–ü–æ–ª–Ω–∞—è –º–æ—â–Ω–æ—Å—Ç—å\n–í—ã—Å–æ–∫–∞—è –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç—å\n–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å'
            },
            {
                id: 'step3-week5',
                label: '–ù–µ–¥–µ–ª—è 5+',
                type: 'timeline',
                x: 550,
                y: 270,
                svgIcon: '/assets/icons-arbitrage/money-tree.svg',
                description: '–ü–∏–∫–æ–≤–∞—è –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç—å\n–î–æ 72.8% –≤ –¥–µ–Ω—å\n–°—Ç–∞–±–∏–ª—å–Ω–∞—è –ø—Ä–∏–±—ã–ª—å'
            },
            {
                id: 'step3-month3',
                label: '–ú–µ—Å—è—Ü 3',
                type: 'timeline',
                x: 700,
                y: 150,
                svgIcon: '/assets/icons-arbitrage/balance.svg',
                description: '–ë–ï–ó–£–ë–´–¢–û–ö\n–ü–æ–∫—Ä—ã—Ç–∏–µ –≤—Å–µ—Ö –∑–∞—Ç—Ä–∞—Ç\n–ù–∞—á–∞–ª–æ —á–∏—Å—Ç–æ–π –ø—Ä–∏–±—ã–ª–∏'
            },

            // ===== –®–ê–ì 4: –í–ê–ñ–ù–´–ï –ü–†–ê–í–ò–õ–ê (x=900) =====
            {
                id: 'step4-rule1',
                label: '–®–ê–ì 4: –ù–µ –ø—Ä–æ–¥–∞–≤–∞—Ç—å',
                type: 'rule',
                x: 900,
                y: 250,
                svgIcon: '/assets/icons-arbitrage/stop.svg',
                description: '–ó–ê–ü–†–ï–¢ –ø—Ä–æ–¥–∞–∂–∏ PLEX\n–ü—Ä–æ–¥–∞–ª = –±–æ—Ç –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –ù–ê–í–°–ï–ì–î–ê\n–ü—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π –∑–∞–º–æ–∫'
            },
            {
                id: 'step4-rule2',
                label: '–ù–µ –º–µ–Ω—è—Ç—å –¥–µ–ø–æ–∑–∏—Ç',
                type: 'rule',
                x: 900,
                y: 450,
                svgIcon: '/assets/icons-arbitrage/lock.svg',
                description: '–§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å—É–º–º–∞\n–ò–∑–º–µ–Ω–µ–Ω–∏–µ = —Å–±—Ä–æ—Å –ø—Ä–æ–≥—Ä–µ—Å—Å–∞\n–î–∏—Å—Ü–∏–ø–ª–∏–Ω–∞ –≤–∞–∂–Ω–∞'
            },
            {
                id: 'step4-rule3',
                label: '–ü–ª–∞—Ç–∏—Ç—å –∫–∞–∂–¥—ã–π –¥–µ–Ω—å',
                type: 'rule',
                x: 900,
                y: 650,
                svgIcon: '/assets/icons-arbitrage/calendar.svg',
                description: '–ï–∂–µ–¥–Ω–µ–≤–Ω–∞—è –∫–æ–º–∏—Å—Å–∏—è\n–ü—Ä–æ–ø—É—Å–∫ = –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –±–æ—Ç–∞\n–ë–µ–∑ –≤—ã—Ö–æ–¥–Ω—ã—Ö'
            },

            // ===== –®–ê–ì 5: –û–ñ–ò–î–ê–ï–ú–´–ï –†–ï–ó–£–õ–¨–¢–ê–¢–´ (x=1100) =====
            {
                id: 'step5-profit',
                label: '–®–ê–ì 5: –ü—Ä–∏–±—ã–ª—å',
                type: 'result',
                x: 1100,
                y: 250,
                svgIcon: '/assets/icons-arbitrage/chart.svg',
                description: '–¢–æ—Ä–≥–æ–≤–∞—è –ø—Ä–∏–±—ã–ª—å\n–†–∞—Å—Ç–µ—Ç —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–æ\n–†–µ–∞–ª—å–Ω—ã–π –¥–æ—Ö–æ–¥'
            },
            {
                id: 'step5-growth',
                label: '–†–æ—Å—Ç –∞–∫—Ç–∏–≤–æ–≤',
                type: 'result',
                x: 1100,
                y: 450,
                svgIcon: '/assets/icons-arbitrage/rocket.svg',
                description: '–†–æ—Å—Ç —Ö–æ–ª–¥–∏–Ω–≥–∞ PLEX\n–î–æ–ª–≥–æ—Å—Ä–æ—á–Ω–∞—è –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏—è\n–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª —Ä–æ—Å—Ç–∞ —Ç–æ–∫–µ–Ω–∞'
            },
            {
                id: 'step5-total',
                label: '–ò–¢–û–ì–û',
                type: 'result',
                x: 1100,
                y: 650,
                svgIcon: '/assets/icons-arbitrage/trophy.svg',
                description: '–ó–Ω–∞—á–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–∏–±—ã–ª—å –≤–æ–∑–º–æ–∂–Ω–∞\n–í—ã—Å–æ–∫–∏–π –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª ROI\n‚ö†Ô∏è –¢—Ä–µ–±—É–µ—Ç —Ç–µ—Ä–ø–µ–Ω–∏—è –∏ –¥–∏—Å—Ü–∏–ø–ª–∏–Ω—ã'
            },

            // ===== ARBITRAGEBOT - –§–ò–ù–ê–õ–¨–ù–´–ô –£–ó–ï–õ (x=1280) =====
            {
                id: 'core',
                label: 'ARBITRAGEBOT',
                type: 'core',
                x: 1280,
                y: 450,
                svgIcon: '/assets/icons-arbitrage/robot.svg',
                description: '–î–æ—Å—Ç—É–ø –∫ –±–æ—Ç—É\n–í—ã—Å–æ–∫–∞—è –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç—å\n–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∞—Ä–±–∏—Ç—Ä–∞–∂'
            },
        ];

        // Define connections between nodes
        // –ù–û–í–ê–Ø –°–¢–†–£–ö–¢–£–†–ê –°–í–Ø–ó–ï–ô: –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–π –ø–æ—Ç–æ–∫ —Å–ª–µ–≤–∞ –Ω–∞–ø—Ä–∞–≤–æ
        this.links = [
            // ===== –®–ê–ì 1: –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è —Å–≤—è–∑–∞–Ω—ã –º–µ–∂–¥—É —Å–æ–±–æ–π =====
            { source: 'step1-plex', target: 'step1-rabbits' },

            // ===== –®–ê–ì 1 ‚Üí –®–ê–ì 2 =====
            { source: 'step1-plex', target: 'step2-deposit' },
            { source: 'step1-rabbits', target: 'step2-commission' },

            // ===== –®–ê–ì 2: –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è —Å–≤—è–∑–∞–Ω—ã –º–µ–∂–¥—É —Å–æ–±–æ–π =====
            { source: 'step2-deposit', target: 'step2-commission' },

            // ===== –®–ê–ì 2 ‚Üí –®–ê–ì 3 (–Ω–∞—á–∞–ª–æ —Ä–∞–±–æ—Ç—ã –±–æ—Ç–∞) =====
            { source: 'step2-deposit', target: 'step3-week1' },
            { source: 'step2-commission', target: 'step3-week1' },

            // ===== –®–ê–ì 3: –ù–µ–¥–µ–ª–∏ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ (–∑–∏–≥–∑–∞–≥) =====
            { source: 'step3-week1', target: 'step3-week2' },
            { source: 'step3-week2', target: 'step3-week3' },
            { source: 'step3-week3', target: 'step3-week4' },
            { source: 'step3-week4', target: 'step3-week5' },
            { source: 'step3-week5', target: 'step3-month3' },

            // ===== –®–ê–ì 3 ‚Üí –®–ê–ì 4 (–≤–∞–∂–Ω–æ—Å—Ç—å –ø—Ä–∞–≤–∏–ª) =====
            { source: 'step3-month3', target: 'step4-rule2' },

            // ===== –®–ê–ì 4: –ü—Ä–∞–≤–∏–ª–∞ —Å–≤—è–∑–∞–Ω—ã –º–µ–∂–¥—É —Å–æ–±–æ–π =====
            { source: 'step4-rule1', target: 'step4-rule2' },
            { source: 'step4-rule2', target: 'step4-rule3' },

            // ===== –ü—Ä–∞–≤–∏–ª–∞ —Å–≤—è–∑–∞–Ω—ã —Å –≤—Ö–æ–¥–Ω—ã–º–∏ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º–∏ (–≤–∞–∂–Ω–æ—Å—Ç—å —Å–æ–±–ª—é–¥–µ–Ω–∏—è) =====
            { source: 'step4-rule1', target: 'step1-plex' },
            { source: 'step4-rule3', target: 'step2-commission' },

            // ===== –®–ê–ì 4 ‚Üí –®–ê–ì 5 (—Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã) =====
            { source: 'step4-rule2', target: 'step5-growth' },

            // ===== –®–ê–ì 5: –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å–≤—è–∑–∞–Ω—ã –º–µ–∂–¥—É —Å–æ–±–æ–π =====
            { source: 'step5-profit', target: 'step5-growth' },
            { source: 'step5-growth', target: 'step5-total' },

            // ===== –í—Ä–µ–º–µ–Ω–Ω–∞—è —à–∫–∞–ª–∞ –≤–ª–∏—è–µ—Ç –Ω–∞ –ø—Ä–∏–±—ã–ª—å =====
            { source: 'step3-month3', target: 'step5-profit' },

            // ===== –®–ê–ì 5 ‚Üí ARBITRAGEBOT (—Ñ–∏–Ω–∞–ª - –¥–æ—Å—Ç—É–ø –∫ –±–æ—Ç—É) =====
            { source: 'step5-profit', target: 'core' },
            { source: 'step5-total', target: 'core' },
        ];
    }

    /**
     * Smooth zoom with target interpolation
     */
    smoothZoom(factor) {
        this.targetScale = Math.max(0.3, Math.min(3, this.targetScale * factor));
    }

    /**
     * Reset view
     */
    reset() {
        this.targetScale = 1;
        this.targetX = 0;
        this.targetY = 0;
    }

    /**
     * Center view on the core node
     */
    centerView() {
        const coreNode = this.nodes.find(n => n.id === 'core');
        if (!coreNode) return;

        const svgRect = this.svg.getBoundingClientRect();
        this.targetX = svgRect.width / 2 - coreNode.x;
        this.targetY = svgRect.height / 2 - coreNode.y;
        this.targetScale = 1;
    }

    /**
     * Cleanup
     */
    destroy() {
        if (this.animationFrame) {
            cancelAnimationFrame(this.animationFrame);
        }
        this.initialized = false;
    }
}

// Export to window for global access
if (typeof window !== 'undefined') {
    window.MindMapCore = MindMapCore;
}
